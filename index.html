<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Data Link Serial Protocol: A Data Link layer serial protocol</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Data Link Serial Protocol
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('index.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">A Data Link layer serial protocol </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> <a href="https://github.com/LRDPRDX/DataLinkSerialProtocol/actions/workflows/doc.yml"><img src="https://github.com/LRDPRDX/DataLinkSerialProtocol/actions/workflows/doc.yml/badge.svg" alt="Docs" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/LRDPRDX/DataLinkSerialProtocol/actions/workflows/pages/pages-build-deployment"><img src="https://github.com/LRDPRDX/DataLinkSerialProtocol/actions/workflows/pages/pages-build-deployment/badge.svg" alt="pages-build-deployment" style="pointer-events: none;" class="inline"/></a></p>
<p>Written primarly for communication between Arduino and PC but, I believe, can be used in any applications (if suitable, see <em>Key feautures</em> below)</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Key features</h1>
<ul>
<li>Byte stuffing</li>
<li>Header only</li>
<li>Max length of a (raw) message = 126 bytes</li>
<li>Stream message decoding (byte by byte) possible</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Description &amp; terminology</h1>
<p>Suppose we have <code>n</code> bytes of <em>data</em> <code>a₀, a₁, a₂, ..., aₙ₋₁</code> to send from one device to another over a serial communication channel: i.e. one byte (even bit) at a time. It means we need to synchronize the sender and the receiver, so the latter knows, f.e., when the message starts and when it ends. To do this we will first encode the message into a <em>frame</em> <code>b₀, b₁, b₂, ..., bₘ₋₂, bₘ₋₁</code> in such a way that a frame always starts with the same byte <code>b₀</code> (HDR) and ends with the same (different in our case from the start byte) byte <code>bₘ₋₁</code> (FTR). But then we need to handle properly the start and end bytes if they appear in the data itself - in other words we have to <em>escape</em> those bytes. This is pretty much all the code does - it allows you to encode and decode data. See Fig.1 below and the article in the Acknowledgements section for details.</p>
<div class="image">
<img src="diagram.png" alt=""/>
<div class="caption">
Fig.1</div></div>
    <h2><a class="anchor" id="autotoc_md3"></a>
Definitions</h2>
<ul>
<li><b>data</b> : the raw message we want to send</li>
<li><b>special bytes</b> : metabytes, serve special roles in the encoding process</li>
<li><b>frame</b> : the encoded message starting with HDR, ending with FTR, with all special bytes escaped. The <em>actual</em> message to send</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Internals</h2>
<p>The whole functionality is placed into the <code><a class="el" href="structproto_1_1Bicoder.html">proto::Bicoder</a></code> class template. One can say that a good practice is to divide the encoder and decoder, but the class is quite small too store everything inside. This is where the name comes from.</p>
<p>This class has a buffer in which it puts the encoded/decoded message.</p>
<dl class="section warning"><dt>Warning</dt><dd>The buffer is shared between the decoder and encoder: it is overwritten each time a new operation has been started. So be sure you've done with the result of the last operation before you start a new one.</dd></dl>
<h3><a class="anchor" id="autotoc_md5"></a>
Encoding</h3>
<p>The encoding process is quite straightforward. The algorithm is shown in Fig.2:</p>
<div class="image">
<img src="encoding.png" alt=""/>
<div class="caption">
Fig.2</div></div>
    <p>Note how a special byte is encoded:</p>
<div class="image">
<img src="special_encode.png" alt=""/>
<div class="caption">
Fig.3</div></div>
    <p>i.e. a special byte <code>aₛ</code> is encoded with two bytes:</p>
<ul>
<li><code>ESC</code></li>
<li><code>aₛ xor XOR</code></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The <b>HDR</b> and <b>FTR</b> characters are actually printable ASCII '{' and '}' respectively. So if your data has no special bytes you can debug your channel without any additional software: just put the frames by hand. I do this for my project: I send this to my Arduino board right from the serial monitor: <div class="fragment"><div class="line">{mz&gt;1000}</div>
</div><!-- fragment --></dd></dl>
<h3><a class="anchor" id="autotoc_md6"></a>
Decoding</h3>
<p>The decoder part of the <code><a class="el" href="structproto_1_1Bicoder.html">proto::Bicoder</a></code> class is a finite state machine with the following diagram:</p>
<div class="image">
<img src="fsm.png" alt=""/>
<div class="caption">
Fig.4</div></div>
    <dl class="section note"><dt>Note</dt><dd>The decoding of a special byte is quite simple: if the <b>ESC</b> byte is found in the encoded message then the next byte is a special byte <b>xor</b>'ed with the <b>XOR</b> byte. So in order to extract the original byte we need to <b>xor</b> the encoded byte again with the <b>XOR</b> byte.</dd></dl>
<div class="image">
<img src="decode_special.png" alt=""/>
<div class="caption">
Fig.5</div></div>
    <h1><a class="anchor" id="autotoc_md7"></a>
Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;DataLinkSerialProtocol.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceproto.html">proto</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// An auxiliary function to compare two buffers</span></div>
<div class="line"><span class="keywordtype">bool</span> compare( <span class="keyword">const</span> uint8_t* buff1, uint8_t size1,</div>
<div class="line">              <span class="keyword">const</span> uint8_t* buff2, uint8_t size2 )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( size1 != size2 )</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>( uint8_t i = 0; i &lt; size1; ++i )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( buff1[i] != buff2[i] )</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main ()</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_struct" href="structproto_1_1Bicoder.html">Bicoder&lt;5&gt;</a> bicoder;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Aliases to type less</span></div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t HDR = ESpecial::eHDR;</div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t FTR = ESpecial::eFTR;</div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t ESC = ESpecial::eESC;</div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t XOR = ESpecial::eXOR;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Raw data containing only two bytes both of which are special</span></div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t data[] = { HDR, ESC };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The encoded frame</span></div>
<div class="line">    <span class="keyword">constexpr</span> uint8_t frame[] = {</div>
<div class="line">                                  HDR,            <span class="comment">// header</span></div>
<div class="line">                                  ESC, HDR ^ XOR, <span class="comment">// escape HDR</span></div>
<div class="line">                                  ESC, ESC ^ XOR, <span class="comment">// escape ESC</span></div>
<div class="line">                                  FTR             <span class="comment">// footer</span></div>
<div class="line">                                };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Encode the raw message</span></div>
<div class="line">    bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#ac7e3e23ae13c2a9cff6435c2b004c49c">encodeMessage</a>(data, <span class="keyword">sizeof</span>(data));</div>
<div class="line">    assert(bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#a644e2f701aac694c60b0780e31a94521">isCompleted</a>());</div>
<div class="line">    assert(compare(bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#ad07804762287718cf19907908391bceb">buff</a>(), bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#a169f8f8442ff1ad50dac3f53be3da9c9">size</a>(),</div>
<div class="line">                   frame,          <span class="keyword">sizeof</span>(frame)));</div>
<div class="line"> </div>
<div class="line">    bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#a258b49ebdf07f0ed9de5ae22d26635db">reset</a>();</div>
<div class="line">    <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; <span class="keyword">sizeof</span>(frame); ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#a644e2f701aac694c60b0780e31a94521">isCompleted</a>())</div>
<div class="line">        {</div>
<div class="line">            assert(compare(bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#ad07804762287718cf19907908391bceb">buff</a>(), bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#a169f8f8442ff1ad50dac3f53be3da9c9">size</a>(),</div>
<div class="line">                           data,           <span class="keyword">sizeof</span>(data)));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        bicoder.<a class="code hl_function" href="structproto_1_1Bicoder.html#ac426c93b111172dcc335358c06979205">decodeByte</a>(frame[i]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceproto_html"><div class="ttname"><a href="namespaceproto.html">proto</a></div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:14</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html"><div class="ttname"><a href="structproto_1_1Bicoder.html">proto::Bicoder</a></div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:76</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_a169f8f8442ff1ad50dac3f53be3da9c9"><div class="ttname"><a href="structproto_1_1Bicoder.html#a169f8f8442ff1ad50dac3f53be3da9c9">proto::Bicoder::size</a></div><div class="ttdeci">uint8_t size() const</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:172</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_a258b49ebdf07f0ed9de5ae22d26635db"><div class="ttname"><a href="structproto_1_1Bicoder.html#a258b49ebdf07f0ed9de5ae22d26635db">proto::Bicoder::reset</a></div><div class="ttdeci">void reset()</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:220</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_a644e2f701aac694c60b0780e31a94521"><div class="ttname"><a href="structproto_1_1Bicoder.html#a644e2f701aac694c60b0780e31a94521">proto::Bicoder::isCompleted</a></div><div class="ttdeci">bool isCompleted() const</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:164</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_ac426c93b111172dcc335358c06979205"><div class="ttname"><a href="structproto_1_1Bicoder.html#ac426c93b111172dcc335358c06979205">proto::Bicoder::decodeByte</a></div><div class="ttdeci">bool decodeByte(const uint8_t data)</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:228</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_ac7e3e23ae13c2a9cff6435c2b004c49c"><div class="ttname"><a href="structproto_1_1Bicoder.html#ac7e3e23ae13c2a9cff6435c2b004c49c">proto::Bicoder::encodeMessage</a></div><div class="ttdeci">bool encodeMessage(const uint8_t *data, uint8_t size)</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:266</div></div>
<div class="ttc" id="astructproto_1_1Bicoder_html_ad07804762287718cf19907908391bceb"><div class="ttname"><a href="structproto_1_1Bicoder.html#ad07804762287718cf19907908391bceb">proto::Bicoder::buff</a></div><div class="ttdeci">const uint8_t * buff() const</div><div class="ttdef"><b>Definition</b> DataLinkSerialProtocol.h:179</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Documentation</h1>
<p>Available here: <a href="https://lrdprdx.github.io/DataLinkSerialProtocol/index.html">https://lrdprdx.github.io/DataLinkSerialProtocol/index.html</a></p>
<h1><a class="anchor" id="autotoc_md9"></a>
Acknowledgements</h1>
<p>This protocol is based on this article : <a href="https://eli.thegreenplace.net/2009/08/12/framing-in-serial-communications/">https://eli.thegreenplace.net/2009/08/12/framing-in-serial-communications/</a></p>
<h1><a class="anchor" id="autotoc_md10"></a>
TODO</h1>
<ul class="check">
<li class="unchecked">Add <code>keywords.txt</code> </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
